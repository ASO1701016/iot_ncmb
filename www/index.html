<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src *; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
    <script src="components/loader.js"></script>
    <link rel="stylesheet" href="components/loader.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="timeline/jquery.timelineMe.css">
    <script type="text/javascript" src="timeline/jquery.timelineMe.js"></script>

    <script>

    //STEP 0: APIキーを設定し、初期化を行います
    var applicationKey = "APPLICATION_KEY";
    var clientKey = "CLIENT_KEY";
    var ncmb = new NCMB(applicationKey, clientKey);

    var items = [];

    function displayStatusImage() {
        //STEP 1. ドアのステータスを表示するコードをここに追加します
        var Status = ncmb.DataStore("DoorData");
        //STEP 1.1 DoorDataクラスを検索するオブジェクトを準備
        Status.order("createDate", true)
            .fetch()
            .then(function(result){
                //STEP 1.2.1 検索結果を処理し、表示
                if(result.status == 1) {
                        $("#statusImg").attr("src", "image/closed.png" );
                    } else {
                        $("#statusImg").attr("src", "image/open.png" );
                    }
            })
            .catch(function(err){
                console.log(err);
            });
    }

    function displayTimeline() {
        //STEP 2. タイムラインを表示するコードをここに追加します
        var Status = ncmb.DataStore("DoorData");
        //STEP 2.1 DoorDataクラスを検索するオブジェクトを準備
        Status.order("createDate", true)
            .limit(30)
            .fetchAll()
            .then(function(results){
                //STEP 2.2.1 検索結果を処理し、表示
                for (var i = 0; i < results.length; i++) {
                    var object = results[i];
                    var item = {};
                    item.type = "smallItem";
                    item.label = displayDateTime(convertDate(object.createDate));
                    if (object.status == 1) {
                        item.shortContent = "閉 CLOSED";
                    } else {
                        item.shortContent = "開 OPENED";
                    }
                    item.forcePosition = 'right';
                    items[i] = item;
                }
                $('#timeline-container').timelineMe({"items": items});
            })
            .catch(function(err){
                console.log(err);
            });
    }

    //STEP 3 プッシュ通知準備
    document.addEventListener("deviceready", function(){
            // デバイストークンを取得してinstallationに登録する
            window.NCMB.monaca.setDeviceToken(
                applicationKey,
                clientKey,
                "PROJECT_NUMBER(Android_only)"
            );
    },false);


    function convertDate(utcString) {
        var regexp = new RegExp(
          "^([0-9]{1,4})-([0-9]{1,2})-([0-9]{1,2})" + "T" +
          "([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2})" +
          "(.([0-9]+))?" + "Z$");
        var match = regexp.exec(utcString);
        if (!match) {
          return null;
        }
        var year = match[1] || 0;
        var month = (match[2] || 1) - 1;
        var day = match[3] || 0;
        var hour = match[4] || 0;
        var minute = match[5] || 0;
        var second = match[6] || 0;
        var milli = match[8] || 0;
        return new Date(Date.UTC(year, month, day, hour, minute, second, milli));
    }

    function displayDateTime(d) {
        return d.getUTCFullYear()+'-'
          + (d.getMonth()+1) +'-'
          + d.getDate()+' '
          + d.getHours()+':'
          + d.getMinutes()+':'
          + d.getSeconds();
    }

    $(document).ready(function() {
        displayTimeline();
        displayStatusImage();
    });

    document.addEventListener("resume", onResume, false);
    function onResume() {
        displayTimeline();
        displayStatusImage();
    }

    </script>
</head>
<body>
<center>
    <div class="status-img">
        現在の状態<br />
        <img src="" id="statusImg" height="100"> </img>
    </div>
    <a href="">更新</a><br />
    <div style="background-color:#C6D6F0;height: 300px; overflow: auto;" id="timeline-container"></div>
</center>
</body>
</html>
