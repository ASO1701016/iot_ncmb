<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src *; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
    <script src="components/loader.js"></script>
    <link rel="stylesheet" href="components/loader.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="timeline/jquery.timelineMe.css">
    <script type="text/javascript" src="timeline/jquery.timelineMe.js"></script>

    <script>

    var applicationKey = "APPLICATION KEY";
    var clientKey = "CLIENT KEY";
    var ncmb = new NCMB(applicationKey, clientKey);
    var items = [];

    document.addEventListener("deviceready", function()
    {
        window.NCMB.monaca.setHandler
        (
            function(jsonData){
                alert("callback :::" + JSON.stringify(jsonData));
            }
        );
        window.NCMB.monaca.setDeviceToken(
             applicationKey, clientKey,"ANDROID_SET_KEY" );
        window.NCMB.monaca.setReceiptStatus(true);
    },false);

    function displayTimeline() {
        var Status = ncmb.DataStore("DoorData");
        Status.order("createDate", true)
            .limit(30)
            .fetchAll()
            .then(function(results){
                for (var i = 0; i < results.length; i++) {
                    var object = results[i];
                    var item = {};
                    item.type = "smallItem";
                    item.label = displayDateTime(convertDate(object.createDate));
                    if (object.status == 1) {
                        item.shortContent = "閉 CLOSED";
                    } else {
                        item.shortContent = "開 OPENED";
                    }
                    item.forcePosition = 'right';
                    items[i] = item;
                }
                $('#timeline-container').timelineMe({
                    items
                });
            })
            .catch(function(err){
                console.log(err);
            });
    }

    function displayStatusImage() {
        var Status = ncmb.DataStore("DoorData");
        Status.order("createDate", true)
            .fetch()
            .then(function(result){
                    if(result.status == 1) {
                        $("#statusImg").attr("src", "image/closed.png" );
                    } else {
                        $("#statusImg").attr("src", "image/open.png" );
                    }
            })
            .catch(function(err){
                console.log(err);
            });
    }

    function convertDate(utcString) {
        var regexp = new RegExp(
          "^([0-9]{1,4})-([0-9]{1,2})-([0-9]{1,2})" + "T" +
          "([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2})" +
          "(.([0-9]+))?" + "Z$");
        var match = regexp.exec(utcString);
        if (!match) {
          return null;
        }
        var year = match[1] || 0;
        var month = (match[2] || 1) - 1;
        var day = match[3] || 0;
        var hour = match[4] || 0;
        var minute = match[5] || 0;
        var second = match[6] || 0;
        var milli = match[8] || 0;
        return new Date(Date.UTC(year, month, day, hour, minute, second, milli));
    }

    function displayDateTime(d) {
        return d.getUTCFullYear()+'-'
          + (d.getMonth()+1) +'-'
          + d.getDate()+' '
          + d.getHours()+':'
          + d.getMinutes()+':'
          + d.getSeconds();
    }

    $(document).ready(function() {
        displayTimeline();
        displayStatusImage();
    });


    </script>
</head>
<body>
<center>
    <div class="status-img">
        現在の状態<br />
        <img src="" id="statusImg" height="100"> </img>
    </div>
    タイムライン<br />
    <div style="background-color:#C6D6F0;height: 300px; overflow: auto;" id="timeline-container"></div>
</center>
</body>
</html>
